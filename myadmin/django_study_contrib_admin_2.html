<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.7: http://docutils.sourceforge.net/" />
<title>Django研究之admin系统(二）</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 6253 2010-03-02 00:24:53Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="djangoadmin">
<h1 class="title">Django研究之admin系统(二）</h1>

<p>接着 <a class="reference external" href="http://towerjoo.blog.techweb.com.cn/archives/99.html">上文</a> 的内容，本文将基于自己的理解尝试回答 <a class="reference external" href="http://towerjoo.blog.techweb.com.cn/archives/99.html">上文</a> 中研究列表中的3和4，即：</p>
<ol class="arabic simple" start="3">
<li>理解和分析Admin系统的设计和代码书写值得学习和注意的问题</li>
<li>总结</li>
</ol>
<div class="section" id="admin">
<h1>理解和分析Admin系统的设计和代码书写</h1>
<p>Admin系统具有多种特征，首先它是一个普通的 <a class="reference external" href="http://djangoproject.com">Django</a> 应用，其次它又承担
作为各个其它Djago应用的基础应用而存在，所以我们可以从上面两个方面
来加以分析。</p>
<div class="section" id="id1">
<h2>作为一个普通的应用</h2>
<p><a class="reference external" href="http://djangoproject.com">Django</a> 本身是一个基于MVC的web框架，各个层次非常清楚，当然在 <a class="reference external" href="http://djangoproject.com">Django</a> 中，更多地被
称为MTV，即Model, Template, View，对应于MVC的Model, View, Controller。
其中Template和View的衔接是通过url映射完成，而url映射也是 <a class="reference external" href="http://djangoproject.com">Django</a> 架构中最为巧妙的
地方。</p>
<img alt="http://towerjoo.blog.techweb.com.cn/wp-content/blogs.dir/14215/files/blog/django_layers.png" src="http://towerjoo.blog.techweb.com.cn/wp-content/blogs.dir/14215/files/blog/django_layers.png" />
<p>对于一个 <a class="reference external" href="http://djangoproject.com">Django</a> 的应用，我们通常可以从url映射入手，找到url处理的函数，和渲染出的页面，
从而理清整个的应用逻辑。</p>
<blockquote>
<a class="reference external" href="http://djangoproject.com">Django</a> 的Admin应用的url映射大致如下：</blockquote>
<pre class="literal-block">
# sites.py
urlpatterns = patterns('',
    url(r'^$',
        wrap(self.index),
        name='index'),
    url(r'^logout/$',
        wrap(self.logout),
        name='logout'),
    url(r'^password_change/$',
        wrap(self.password_change, cacheable=True),
        name='password_change'),
    url(r'^password_change/done/$',
        wrap(self.password_change_done, cacheable=True),
        name='password_change_done'),
    url(r'^jsi18n/$',
        wrap(self.i18n_javascript, cacheable=True),
        name='jsi18n'),
    url(r'^r/(?P&lt;content_type_id&gt;\d+)/(?P&lt;object_id&gt;.+)/$',
        'django.views.defaults.shortcut'),
    url(r'^(?P&lt;app_label&gt;\w+)/$',
        wrap(self.app_index),
        name='app_list')
    )

# Add in each model's views.
for model, model_admin in self._registry.iteritems():
    urlpatterns += patterns('',
        url(r'^%s/%s/' % (model._meta.app_label, model._meta.module_name),
                include(model_admin.urls))
    )
</pre>
<p>从上面的代码，我们可以看到，Admin应用的landing page，登出，密码修改等相应的逻辑，
重点查看最后几行代码，将已经注册的应用的model(数据库的表)相应url映射指向了其自身的方法。</p>
<p>我们来看model_admin.urls这个逻辑：</p>
<pre class="literal-block">
urlpatterns = patterns('',
    url(r'^$',
        wrap(self.changelist_view),
        name='%s_%s_changelist' % info),
    url(r'^add/$',
        wrap(self.add_view),
        name='%s_%s_add' % info),

    # added by Tower Joo At 2011/2/27
    # have to be ahead of change_view unless it will be overrided
    url(r'^export/$',
        wrap(self.export),
        name='%s_%s_export' % info),
    url(r'^aggregate/$',
        wrap(self.aggregate),
        name='%s_%s_aggregate' % info),

    url(r'^(.+)/history/$',
        wrap(self.history_view),
        name='%s_%s_history' % info),
    url(r'^(.+)/delete/$',
        wrap(self.delete_view),
        name='%s_%s_delete' % info),
    url(r'^(.+)/$',
            wrap(self.change_view),
            name='%s_%s_change' % info),
    )
</pre>
<p>从上面的url映射来看，已经包含了增加记录，删除记录，修改记录等操作，当然上面也包含了
在 <a class="reference external" href="http://towerjoo.blog.techweb.com.cn/archives/99.html">上文</a> 中我做的一些url映射的修改。</p>
<p>看过上面的url映射后，心里就会有数，知道整个Admin系统大致有多少个页面，各个页面的作用是什么。</p>
<p>然后，我们可以通过url映射知道处理这个url的函数，例如，处理/add/的self.add_view函数。
通过阅读self.add_view函数的代码，除了相比于我们通常的逻辑更多的边界和条件处理外，其它的
也是相同的，例如数据库的操作，页面渲染所需要的数据准备等。</p>
<dl class="docutils">
<dt>最后，我们看到的是页面渲染所需要的Template, change_form.html，查看对应的代码，则与通常的</dt>
<dd><a class="reference external" href="http://djangoproject.com">Django</a> 的Template并无二异。</dd>
</dl>
<p>其它的逻辑也相同。相比于我们自己的 <a class="reference external" href="http://djangoproject.com">Django</a> 应用，这个逻辑中有更多的边界条件的处理和异常的处理
等，你可能会说它过于复杂，这也就引入了我们接下来要说明的第二个问题。</p>
</div>
<div class="section" id="id2">
<h2>作为其它应用的通用基础应用</h2>
<p>作为一个基础的应用，它就需要适应所有基于其上的其它应用的需要。
通用性通常意味着更多的复杂性，我们来看 <a class="reference external" href="http://djangoproject.com">Django</a> 是如何有效且优美地处理这个问题的。</p>
<ol class="arabic simple">
<li>充分使用Python的内省，也即model的元数据，如app_label, module_name等，使得动态地构造url映射
和合适的显示成为可能</li>
<li>admin = AdminSite()是一个全局的变量，来维护所有的注册应用的列表</li>
<li>两级的处理结构：admin site级和table级，分别由两个类来处理，并完成相应的url映射</li>
<li>可配置性：对于其上层的应用，都提供了完善的可override的属性，如list_display,list_filter等等</li>
<li>使用类而非 <a class="reference external" href="http://djangoproject.com">Django</a> 默认推荐的函数作为view的处理，这样就提供了用户基于Admin系统建立自己的Admin系统的可能</li>
</ol>
</div>
</div>
<div class="section" id="id3">
<h1>总结</h1>
<p>Admin系统可谓是 <a class="reference external" href="http://djangoproject.com">Django</a> 最强大的功能了,它也大大方便了数据库驱动的应用的开发难度,为应用的数据输入,管理等
提供了一个稳定,可靠,方便的管理界面.</p>
<p>从 <a class="reference external" href="http://towerjoo.blog.techweb.com.cn/archives/99.html">上文</a> 和本文的介绍中,我们可以从中学习到一些 <a class="reference external" href="http://djangoproject.com">Django</a> 常用的开发技巧:</p>
<ol class="arabic simple">
<li>基于类的view实现(当然在 <a class="reference external" href="http://djangoproject.com">Django</a> 1.3中已经完全支持class view了, 参考 <a class="reference external" href="http://docs.djangoproject.com/en/dev/topics/class-based-views/">Class-based generic views</a> )</li>
<li>分级的数据处理</li>
<li>可配置性</li>
<li>灵活性</li>
</ol>
<p>会使用 <a class="reference external" href="http://djangoproject.com">Django</a> 的Admin系统那可以让你的工作时间节省30%以上(基于数据库的应用),如果能够弄清楚 <a class="reference external" href="http://djangoproject.com">Django</a> Admin
的实现原理并从中学习到可用于自己实际开发的经验与方法,则可运筹帷幄,谈笑风生地写代码了.</p>
<img alt="../../images/yunchou.jpg" src="../../images/yunchou.jpg" />
</div>
</div>
</body>
</html>
